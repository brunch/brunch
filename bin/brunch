#!/usr/bin/env node
'use strict';

// Not using ES6 in that file since we want it to "launch" on older nodes.
/* eslint-disable prefer-arrow-callback, prefer-template */
/* eslint-env es6:false */
var version = process.versions.node;
if (parseInt(version) < 4) {
  console.error(
    'Your global Brunch installation is trying to load local Brunch v2+, ' +
    'which only supports Node.js v4 or higher (you have ' + version + ').\n' +
    'You have two choices:\n' +
    '  a) Update Node.js to v4+. Then update global Brunch: ' +
    '`npm uninstall -g brunch && npm install -g brunch`\n' +
    '  b) Adjust `package.json` to use Brunch 1.x (outdated, not recommended).'
  );
  process.exit(1);
}

var startTime = Symbol.for('start-time');
global[startTime] = Date.now();

var sysPath = require('path');
var fs = require('fs');

var loadBrunch = function(libPath) {
  require(libPath).run();
};

var loadGlobalBrunch = function() {
  loadBrunch(sysPath.join(fs.realpathSync(__dirname), '..', 'lib'));
};

var localPath = sysPath.join('node_modules', 'brunch');
if (fs.existsSync(localPath)) {
  try {
    loadBrunch(sysPath.dirname(localPath));
  } catch (error) {
    console.error(
      'Brunch: Local install exists, but failed to load it. ' +
      'Continuing with global install:', error
    );
    loadGlobalBrunch();
  }
} else {
  loadGlobalBrunch();
}
